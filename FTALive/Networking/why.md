Azure Networking #2 - アプリケーション配信基盤の設計・展開 # **[home](./appdelivery/README.md)**  | **[next](./overview.md)**
<!--Azure Networking #1 - Azure ネットワークの基礎とハイブリッドネットワークの設計・展開 # **[home](./core/README.md)**  | **[next](./overview.md)**-->



# 1. なぜ Azure Networking を理解しなければいけないのか

Azure を使う上で必ず利用されるサービスとして、Azure のネットワークがあります。Azure 上に仮想マシンを構築する IaaS で利用する場面はもちろんですが、Web アプリケーションを構築するためのサービスやデータベースサービスのような PaaS を利用する場合であっても、Azure のネットワークを必ず通ることになります。

Azure のネットワークがどのようなコンセプトで設計・運用され、どのような機能が提供されているかを知ることは、結果的に短期間・低コスト・高品質な設計につながります。

たとえば、ベストプラクティスに沿わない設計をした場合、安定しない通信や拡張性の低い構成、コストの高い構成、セキュアでない構成が発生し得ます。また、NIC 障害やポート障害、性能等逆に考慮しなくてよい項目に対して設計・構成をしてしまう場合もあります。

そのようなことがないように、オンプレミスのネットワークとの概念の違いや、Azure ならではのネットワークサービス・機能を理解し、設計していく必要があります。

**Azure のネットワークのアーキテクチャーを理解する** ![Azure NW](./images/network-arch.png)

ここでいくつか誤った理解をしている例を挙げます。

## レイヤー2 の存在を意識してしまう

**よくある誤解**

- DHCP や GARP、マルチキャスト等のネットワークのしくみを使用した機能の展開を検討する
- 耐障害性を考慮したサービス用 NIC と管理用 NIC を分ける構成をする

ユーザーが関与できる Azure のネットワークは、ソフトウェア的に実現されたネットワークであり、一部のトラフィックは利用できません。また、仮想マシンの NIC も仮想的に表現されたものであり、複数アタッチすることによる耐障害性の向上につながることはありません。

## 仮想ネットワークのセキュリティやコスト、性能の理解が不十分である

**よくある誤解**

- 仮想マシンの NIC にパブリック IP アドレスを付与しなければインターネットへのアウトバウンド接続ができない
- NSG を使わない/NSG に大きな期待をしてしまう
- ゾーン間のトラフィックに対してコストはかからない
- 他のユーザーが大量のトラフィックを発生させてしまった場合スループットが低下する

Azure の仮想ネットワークには暗黙の NAT 機能があるため、パブリック IP アドレスがない仮想マシンであっても、インターネットへ接続ができます。また、同一の仮想ネットワーク内では、サブネットが分かれていても通信が可能なため、要件に応じて適切な NSG を設定する必要があります。ただし、NSG は、レイヤー4で機能するため高度なフィルタリング機能は期待できません。

仮想ネットワークはゾーンごとにサブネットを作るような、ゾーンを意識した構成は不要です。しかし、ゾーン間のトラフィックにはコストが発生するため、意図しないコストに注意する必要があります。

Azure のネットワークは膨大なトラフィックが発生することを想定されており、また、ユーザー間のネットワークは完全に分離されているため、ノイジーネイバーによる影響を考慮する必要は基本的にありません。

## オンプレミスとの接続で十分な可用性が確保できていない、運用が難しい構成になっている

**よくある誤解**

- Azure からのすべてのトラフィックをオンプレミスに戻すことがセキュアかつ運用可能である
- 閉域網サービス(ExpressRoute)を使うことで Azure に関するすべてのトラフィックがインターネットに送信されないため安全である
- Azure の仮想ネットワーク ゲートウェイや回線を冗長化しているから災害対策は十分である

閉域網サービスは、オンプレミスと Azure の接続をセキュアかつ高品質なネットワークにするためにエンタープライズでは多く使用されるサービスです。ただし、Azure のサービスはさまざまなコンポーネントで構成されていることから、すべてのトラフィックをユーザーの仮想ネットワークとオンプレミス上に完全に閉じ込めることは現実的ではありません。

Azure はパブリッククラウドであるという前提を理解し、トラフィックの内容に応じて柔軟なネットワーク設計することが必要です。

## PaaS との接続がセキュアでない

**よくある誤解**

- PaaS リソースは統一されかつ唯一のネットワーク接続によって簡単にネットワークのアクセス制御が行える
- PaaS リソースを仮想ネットワークに閉じ込める(インジェクションする)ことがセキュアかつ簡単な運用を実現可能である

一口に PaaS と言っても、その種類は多岐に渡ります。それぞれの PaaS リソースが必要なトラフィックは、それぞれのリソースによって異なります。PaaS リソースのネットワークを制御する場合、使いたいサービスがどのようなプロトコルで、どのようなエンドポイントに対して、どのくらいのスループットが必要か等々、個々の機能や制約を確認したうえでシステム要件に適したネットワークアーキテクチャーを検討する必要があります。
