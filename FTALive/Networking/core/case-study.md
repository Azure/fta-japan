# 4. ネットワークアーキテクチャー事例

本章ではよくあるネットワークのアーキテクチャーとしていくつか例を紹介します。

ネットワークのアーキテクチャーを検討する際、始めに以下のような最低限の要件をまとめることをお勧めします。

- ワークロード
- コンポーネント間の通信要件
- Azure に移行する対象

次に、前章で紹介したトポロジと接続、セキュリティ、リソース構成を意識しながら設計します。

これから紹介する事例でも上記ポイントを意識しながらまとめてみましたので参考にしてみてください。

## シナリオ 1: Web サーバーの Azure への移行

インターネットからのアクセスが必要な Web サーバーを Azure へ移行します。

### ワークロードの概要

- Web サーバーでは企業の Web サイトがホストされています
- CMS サーバーから Web サーバーに対してコンテンツを FTP で配信します
- 一般ユーザーは CMS サーバーにブラウザ経由(HTTP) でアクセスします
- 管理者ユーザーは SSH(22 番ポート) で各サーバーにアクセスします

### 要件

- インターネットから接続される Web サーバーと、それらのサーバーを管理する管理用のサーバー(CMS)、踏み台サーバーが存在します
- Web サーバーと CMS のサーバー間(東西間)の通信は一方向(CMS サーバー→Web サーバー)です
- CMS サーバーは OS の更新やミドルウェアの更新のためにインターネットへの接続が必要です
- それぞれのサーバーへはオンプレミスの環境から接続する必要があります
  - オンプレミス → CMS サーバーの HTTP通信は許可します
  - オンプレミス → Web サーバーや CMS サーバーに対する管理アクセスは拒否します
  - オンプレミスから Web サーバーや CMS サーバーへ管理アクセスするには踏み台サーバーを利用します

### 設計のポイント

- トポロジ と 接続方法
  - ハブアンドスポーク構成を採用し、共有リソースと Web サービスを提供するネットワークを分離しています
    - 2 つのネットワーク間はピアリングで接続します
  - インターネットとの接続(南北間の通信)は Application Gateway を利用します
  - オンプレミスネットワークとの接続は ExpressRoute のプライベートピアリングを使用します
- セキュリティ
  - サービスを提供する東西間の通信(Web サーバーと管理用のサーバー)は、サブネットを分割して通信を制御します
    - Web サーバー → 管理用サーバーへの通信はすべて拒否します
    - 管理用サーバー → Web サーバーへの通信は HTTPS(443番ポート) のみ許可します
  - サーバーからの発信は Azure Firewall を通過させ、インターネットへの通信を制御します
  - NSG フロー ログを有効にしてネットワークフローを監視します
- リソース構成
  - 2 つのサブスクリプションを作成し、それぞれ共有リソースと Web サービスのリソースを配置します
    - 共有リソース用のサブスクリプションには、ExpressRoute 回線、VPN Gateway、Azure Firewall、Log Analytics を配置します
  - 共有リソースのネットワークには踏み台サーバーを展開します

![構成図](../images/case-study-1.png)

### 改善のポイント

- 踏み台サーバーの代わりに `Azure Bastion` を利用することでよりセキュアにできます。

## シナリオ 2: オンプレミス環境の業務サーバーの移行

Azure をデータセンターの拡張として業務サーバーを移行し、オンプレミスと Azure 上のサーバーからアクセスします。

### 要件

- インターネットから接続される メールサーバーや WAP サーバーを移行します
  - インターネットから接続されるサーバーは今後追加される可能性があります
- オンプレミス環境にはドメイン コントローラーが存在します
- 社内向けサービスをホストする IIS サーバーの一部を移行します
- データベースは PaaS の SQL Database を利用します(オンプレミスのデータを一部移行します)
- オンプレミス環境には、SQL Database を利用するサーバーが存在します
- 海外の支店(東南アジア)が存在しており、そのオンプレミス環境から一部の社内向けサービスを移行します
  - 日本拠点から海外拠点に管理用途のアクセスが必要です
  - 海外拠点から日本拠点へのアクセスは一部のリソースのみを利用します(ホワイトリストでアクセス制御を行います)
  - 海外拠点のサービスはインターネットからアクセスされることはありません

### 設計のポイント

- トポロジ と 接続方法
  - ハブアンドスポーク構成を採用し、東日本の共有リソースの一部を東南アジアからも利用できるようにします
    - ハブネットワークは東日本と東南アジアにそれぞれ展開します
    - インターネットからの接続がある仮想ネットワークを分離します
    - ハブネットワークには Azure Firewall を展開し、インターネットへの接続、ピアリングされた仮想ネットワーク間の接続を制御します
  - リージョン間はグローバル ピアリングで接続します
  - オンプレミス環境からの接続は東日本に展開した ExpressRoute を利用します
    - ハブネットワークに VPN Gateway を展開します
  - 東南アジアリージョンに展開したリソースへの海外拠点からのアクセスは VPN(Site-to-Site) 接続を利用します
  - SQL Database へのアクセスはプライベート エンドポイントを利用します
    - オンプレミスから SQL Database へのアクセスが行えるように名前解決を設定します
- セキュリティ
  - インターネットからの接続がある仮想ネットワーク → それ以外の仮想ネットワークへの通信は既定で拒否(ホワイトリストで許可)します
  - インターネットへの接続は Azure Firewall を利用します
  - オンプレミスから各サーバーへの通信は基本的に許可します
  - SQL Database へのアクセスは NSG を利用してホワイトリストで許可します
- リソース構成
  - 共有リソースをまとめたサブスクリプションを作成します
    - 共有リソースは ExpressRoute 回線、VPN Gateway、Azure Firewall、Log Analytics です
    - このサブスクリプションには東日本と東南アジアの両方の共有リソースをまとめます
  - 個別のリソースは別のサブスクリプションに展開します
    - 東日本と東南アジアの両方のリソースをまとめます
    - リージョンとシステム(プロジェクト)単位を論理的なグループとし、リソース グループで分割します

![構成図](../images/case-study-2.png)

### 改善のポイント

- `Virtual WAN` を利用するとリージョンやスポークが増えた場合のルート テーブルの管理工数を削減できます
