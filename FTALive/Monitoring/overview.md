# 2. Azure における監視の全体像と機能概要 <!-- no toc -->

## 目次 <!-- omit in toc -->

- [2. Azure における監視の全体像と機能概要](#2-azure-における監視の全体像と機能概要)
  - [2.1 Azure の監視の全体像](#21-azure-の監視の全体像)
  - [2.2 Azure Monitor の概要](#22-azure-monitor-の概要)
    - [2.2.1 データソース](#221-データソース)
      - [Application(作成中)](#application作成中)
      - [Infrastructure](#infrastructure)
      - [Azure Platform](#azure-platform)
    - [2.2.2 データプラットフォーム](#222-データプラットフォーム)
      - [Azure Monitor メトリック データベース](#azure-monitor-メトリック-データベース)
      - [Log Analytics ワークスペース](#log-analytics-ワークスペース)
    - [2.2.3 データ利活用](#223-データ利活用)
      - [メトリック エクスプローラー](#メトリック-エクスプローラー)
  - [2.3 Azure Monitor の機能](#23-azure-monitor-の機能)
  - [2.3 まとめ](#23-まとめ)

## 2.1 Azure の監視の全体像

Azure はさまざまなサービスを提供しており、それらのサービスを監視するための機能が用意されています。まずは Azure における監視の全体像を把握しましょう。

Azure の監視対象として、Azure のリソース以外に、セキュリティやコスト、オンプレミス環境が可能です。本章では、Azure のリソースにフォーカスし、それ以外の監視については必要に応じて補足していきます。

Azure のリソースを監視するには Azure Monitor を利用します。以下は Azure Monitor の機能の全体像です。

![](images/azure-monitor-overview-2022-08-25-change-analysis-opt.svg)

上図のように Azure Monitor の機能は主に 3 つのカテゴリで構成されています。

- データソース
  - Azure のリソースログやメトリック、OS のイベント ログ等のデータをソースとして収集する機能です。
- データプラットフォーム
  - データソースから収集したデータを保存するためのストレージ領域です。
- データ利活用
  - 収集したデータを利用するための機能です。

Azure Monitor でできる監視の内容や方法、コスト、機能についてカテゴリ毎に把握すると理解がしやすくなります。

|:question: Tips: Azure Monitor とは何か|
|:-----------------------------------------|
|ここまでの説明で Azure Monitor というサービスが提供されているように考えられることがありますが、Azure Monitor は 1 つの機能何かを指しているわけではありません。Azure Monitor は複数の機能の総称です。Azure Monitor が登場する以前はさまざまな監視機能がリソース単位やサブスクリプション単位で散らばっており監視機能への統一されたアクセスがありませんでした。そこで Azure Monitor としてリブランディングし、Azure の監視に関連する機能をまとめたものが Azure Monitor です。Azure Monitor の歴史については [こちら](https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/manage/monitor/platform-overview#the-story-of-azure-monitor) のドキュメントを読むと分かります。|

Azure Monitor でできることの一例を以下に挙げます。

- Azure 上の仮想マシンやオンプレミスのサーバーのログ収集や CPU 使用率の監視ができます
- 収集した大量のログをクエリし、分析できます
- SQL Database や App Service、Application Gateway などの Azure リソースのログを収集できます
- ネットワークのログを収集しトラフィック量や送信元を解析し、攻撃を可視化します
- ストレージ アカウントにエクスポートし、ログやメトリックを長期保存できます
- Azure ポータルへのログインを監視し、不正アクセスを検知できます
- Azure のメンテナンスや障害情報をいち早く知ることができます
- ダッシュボードやブックを使用し可視化ができます
- アプリケーションと依存関係の問題を検出して診断します

次の節からは、上記の 3 つのカテゴリのそれぞれの機能を説明していきます。

### :exclamation: 重要: ログとメトリック <!-- omit in toc --> 

Azure Monitor を利用する上で必ず理解しておかなければならない概念・用語がログとメトリックです。

ログは文字列のデータで、OS のイベントログやアプリケーションのログが該当します。メトリックは数値のデータで、CPU 使用率やメモリ使用量が該当します。Azure Monitor では、ログとメトリックのいずれも収集し、保存、可視化ができます。

以下はメトリックの例です。

![](./images/cpu-by-instance.png)

以下はログの例です。

![](./images/overview-log.png)

注意が必要なポイントとして、ログとメトリックを扱うサービスが違う点、保存方法やコストが異なる点です。たとえば、ログを扱うには主に Log Analytics を利用し、メトリックを扱うには Azure Monitor のメトリック機能を利用します。また Log Analytics は課金が発生されるサービスですが、Azure Monitor のメトリックは無料で利用できます。しかし一方で、メトリックをログとして保存できる機能もあり、ドキュメントを確認する際や設計する場合に理解しておく必要があります。

以降の機能の紹介で詳しくログとメトリックについて説明します。

## 2.2 Azure Monitor の概要

この節では、Azure Monitor の 3 つのカテゴリの概要を説明します。

### 2.2.1 データソース

データソースは Azure Monitor へデータを取り込むための機能群です。Azure のリソースのログやメトリック、OS のイベント ログ等のデータをソースとして収集できます。概要で紹介した図にあるデータソースのカテゴリにもとづいて、データソースの機能を紹介します。

#### Application(作成中)

アプリケーションにコードを埋め込むことで、アプリケーションのログやメトリックを Azure Monitor に送信できます。

#### Infrastructure

Azure 上の仮想マシンやオンプレミスのサーバーのログ・メトリックを収集する機能です。従来からサーバーを監視するためにさまざまな製品が利用されていますが、Azure Monitor でも同様の監視が可能です。

Azure 上の仮想マシンを監視する場合、観点として仮想マシンが起動しているホストと仮想マシン自体の監視があります。

仮想マシンのホストの観点で確認できることとしては、仮想マシンが利用している CPU 使用率やディスク I/O、ディスクキャッシュのヒット率、ネットワークスループットなどのメトリックです。仮想マシン自体の観点で確認できることとしては、仮想マシン上の OS から見たログとメトリックです。ログはイベントログや syslog などの OS やアプリケーションが出力するログです。メトリックは CPU 使用率やファイルシステムの利用量、プロセス数があります。

仮想マシンホストのメトリック収集は、Azure Monitor の機能として既定で提供されており、設定や追加のサービス展開は必要ありません。一方で仮想マシンのログとメトリックは、OS にエージェントをインストールすることでデータを収集します。

また、Azure 上の仮想マシンだけでなく、他社クラウドやオンプレミス環境のサーバーのメトリックやログを取得も可能です。

次の図は上記の内容をまとめたものです。

![](./images/overview-1.png)

#### Azure Platform

Azure はデータベースや Web アプリケーションをホストするサービス、ファイアウォールを PaaS で提供しています。それらのリソースのログやメトリックも Azure Monitor で収集できます。たとえば、Web アプリケーションへのリクエスト数やファイアウォールのスループットがあります。ログとしては、Web アプリケーションのアクセスログやファイアウォールの通信ログがあり、`リソース ログ` や `診断ログ`と呼ばれます。

メトリックは、Azure Monitor の機能として既定で提供されており、追加の設定やサービス展開は必要ありません。

リソース ログは、各リソースのメニューにある`診断設定`から設定します。上記の通りリソース ログはリソースによって出力するログの種類が異なります。診断設定では、どのログをどこに出力するかを設定します。また、複数の設定ができるため、同時に複数の Log Analytics や ストレージ アカウントへ出力できます。

以下は Azure Firewall の診断設定で Log Analytics ワークスペースへ出力している例です。
![](./images/overview-azfwdiag.png)

また、以下は、App Service の診断設定でストレージ アカウントへ出力している例です。Azure Firewall とログのカテゴリが異なっています。
![](images/overview-appservice.png)

プラットフォームのログとしてはほかに、リソースの作成や削除を記録している `アクティビティ ログ`、 ユーザーのサインインや監査ログを記録している `Azure Active Directory ログ` があります。これらのログも、診断設定から出力先を設定できます。

### 2.2.2 データプラットフォーム

データプラットフォームは、データソースから収集したデータを蓄積するためのストレージです。Azure Monitor のストレージは、大きく分けてログとメトリックのそれぞれで保存される場所が違います。ログはユーザーが作成した Log Analytics ワークスペースに保存され、メトリックは Azure Monitor のデータストアに保存されます。

#### Azure Monitor メトリック データベース

仮想マシンの CPU 使用率や App Service のリクエスト数等の数値で表されるデータは、データソースから `Azure Monitor メトリック データベース` に保存されます。

メトリック データベースは、ユーザーによる設定やサービスの展開をすることなく利用できる Azure Monitor 既定の機能です。メトリックデータの保存期間は、93日間です。コストも発生しません。

メトリックはデータによってディメンションを持っているものがあります。たとえば、仮想マシンのディスク I/O に関するメトリックは接続されているディスクごとで確認できる必要があります。ディメンションとしてLUNを持つことでメトリックの値を区別します。

メトリック データベースに対して、カスタム メトリックを定義してデータの収集が可能です。カスタム メトリックを利用するとユーザーが定義したメトリックをメトリック データベースに保存し、アラートや可視化が可能です。カスタム メトリックに対しては、保存容量に応じたコストが発生します。

メトリック データベースに保存されたデータは、メトリック エクスプローラーから確認できます。メトリック エクスプローラーに関しては後述します。

#### Log Analytics ワークスペース

Windows の イベント ログや Linux の Syslog などのログデータは、データソースから Log Analytics ワークスペースに保存されます。Azure リソースの診断設定で行ったログの出力も同様です。また、Application Insights を利用したアプリケーションからのログも Log Analytics ワークスペースに保存されます。

Log Analytics ワークスペースは、ユーザーが作成・管理します。データの保存にはコストが発生します。特に取り込むログ量への課金に多くのコストが発生するためログの取り込み対象の選定やワークスペースの分割が重要です。

Log Analytics ワークスペースについては、後述する機能紹介で詳しく説明します。

### 2.2.3 データ利活用

#### メトリック エクスプローラー


|:question: Tips: メトリックの粒度と時間の範囲|
|:-----------------------------------------|
|Azure Monitor に収集されるメトリックはリソースによって断続的に送られるデータです。1分間に1回や5分間に1回等リソースが送信してきたデータを保存します。リソースによってこのサンプリングの間隔が異なるため、アラートの間隔等データを利用する際は注意しておく必要があります。|

## 2.3 Azure Monitor の機能

## 2.3 まとめ
