# 2. Azure における監視の全体像と機能概要 <!-- no toc -->

## 目次 <!-- omit in toc -->

- [2. Azure における監視の全体像と機能概要](#2-azure-における監視の全体像と機能概要)
  - [2.1 Azure の監視の全体像](#21-azure-の監視の全体像)
  - [2.2 Azure Monitor の機能](#22-azure-monitor-の機能)
    - [2.2.1 データソース](#221-データソース)
      - [Application(作成中)](#application作成中)
      - [Infrastructure](#infrastructure)
      - [Azure Platform](#azure-platform)
    - [2.2.2 データプラットフォーム](#222-データプラットフォーム)
      - [Azure Monitor メトリック データベース](#azure-monitor-メトリック-データベース)
      - [Log Analytics ワークスペース](#log-analytics-ワークスペース)
    - [2.2.3 データ利活用](#223-データ利活用)
      - [メトリック エクスプローラー](#メトリック-エクスプローラー)
      - [Log Analytics ワークスペース](#log-analytics-ワークスペース-1)
        - [Kusto Query Language(KQL) とは](#kusto-query-languagekql-とは)
      - [アラート](#アラート)
      - [NSG フローログ](#nsg-フローログ)
  - [2.3 そのほかの技術的なトピック](#23-そのほかの技術的なトピック)
    - [Azure Log Analytics エージェントと Azure Monitor エージェント](#azure-log-analytics-エージェントと-azure-monitor-エージェント)
    - [Log Analytics ワークスペースの課金と利用状況の分析](#log-analytics-ワークスペースの課金と利用状況の分析)
    - [Log Analytics ワークスペースの権限管理](#log-analytics-ワークスペースの権限管理)
    - [サービス正常性、リソース正常性](#サービス正常性リソース正常性)
  - [2.4 まとめ](#24-まとめ)

## 2.1 Azure の監視の全体像

Azure はさまざまなサービスを提供しており、それらのサービスを監視するための機能が用意されています。まずは Azure における監視の全体像を把握しましょう。

Azure の監視対象として、Azure のリソース以外に、セキュリティやコスト、オンプレミス環境が可能です。本章では、Azure のリソースにフォーカスし、それ以外の監視については必要に応じて補足していきます。

Azure のリソースを監視するには Azure Monitor を利用します。以下は Azure Monitor の機能の全体像です。

![](images/azure-monitor-overview-2022-08-25-change-analysis-opt.svg)

上図のように Azure Monitor の機能は主に 3 つのカテゴリで構成されています。

- データソース
  - Azure のリソースログやメトリック、OS のイベント ログ等のデータをソースとして収集する機能です。
- データプラットフォーム
  - データソースから収集したデータを保存するためのストレージ領域です。
- データ利活用
  - 収集したデータを利用するための機能です。

Azure Monitor でできる監視の内容や方法、コスト、機能についてカテゴリ毎に把握すると理解がしやすくなります。

|:question: Tips: Azure Monitor とは何か|
|:-----------------------------------------|
|ここまでの説明で Azure Monitor というサービスが提供されているように考えられることがありますが、Azure Monitor は 1 つの機能何かを指しているわけではありません。Azure Monitor は複数の機能の総称です。Azure Monitor が登場する以前はさまざまな監視機能がリソース単位やサブスクリプション単位で散らばっており監視機能への統一されたアクセスがありませんでした。そこで Azure Monitor としてリブランディングし、Azure の監視に関連する機能をまとめたものが Azure Monitor です。Azure Monitor の歴史については [こちら](https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/manage/monitor/platform-overview#the-story-of-azure-monitor) のドキュメントを読むと分かります。|

Azure Monitor でできることの一例を以下に挙げます。

- Azure 上の仮想マシンやオンプレミスのサーバーのログ収集や CPU 使用率の監視ができます
- 収集した大量のログをクエリし、分析できます
- SQL Database や App Service、Application Gateway などの Azure リソースのログを収集できます
- ネットワークのログを収集しトラフィック量や送信元を解析し、攻撃を可視化します
- ストレージ アカウントにエクスポートし、ログやメトリックを長期保存できます
- Azure ポータルへのログインを監視し、不正アクセスを検知できます
- Azure のメンテナンスや障害情報をいち早く知ることができます
- ダッシュボードやブックを使用し可視化ができます
- アプリケーションと依存関係の問題を検出して診断します

次の節からは、上記の 3 つのカテゴリのそれぞれの機能を説明していきます。

### :exclamation: 重要: ログとメトリック <!-- omit in toc --> 

Azure Monitor を利用する上で必ず理解しておかなければならない概念・用語がログとメトリックです。

ログは文字列のデータで、OS のイベントログやアプリケーションのログが該当します。メトリックは数値のデータで、CPU 使用率やメモリ使用量が該当します。Azure Monitor では、ログとメトリックのいずれも収集し、保存、可視化ができます。

以下はメトリックの例です。

![](./images/cpu-by-instance.png)

以下はログの例です。

![](./images/overview-log.png)

注意が必要なポイントとして、ログとメトリックを扱うサービスが違う点、保存方法やコストが異なる点です。たとえば、ログを扱うには主に Log Analytics を利用し、メトリックを扱うには Azure Monitor のメトリック機能を利用します。また Log Analytics は課金が発生されるサービスですが、Azure Monitor のメトリックは無料で利用できます。しかし一方で、メトリックをログとして保存できる機能もあり、ドキュメントを確認する際や設計する場合に理解しておく必要があります。

以降の機能の紹介で詳しくログとメトリックについて説明します。

## 2.2 Azure Monitor の機能

この節では、Azure Monitor の 3 つのカテゴリの概要を説明します。まずはそれぞれのカテゴリの代表的な機能や利用方法を解説します。

### 2.2.1 データソース

データソースは Azure Monitor へデータを取り込むための機能群です。Azure のリソースのログやメトリック、OS のイベント ログ等のデータをソースとして収集できます。概要で紹介した図にあるデータソースのカテゴリにもとづいて、データソースの機能を紹介します。

#### Application(作成中)

アプリケーションにコードを埋め込むことで、アプリケーションのログやメトリックを Azure Monitor に送信できます。

#### Infrastructure

Azure 上の仮想マシンやオンプレミスのサーバーのログ・メトリックを収集する機能です。従来からサーバーを監視するためにさまざまな製品が利用されているように、Azure Monitor でも同様の監視が可能です。

Azure 上の仮想マシンを監視する場合、観点として仮想マシンが起動しているホストと仮想マシン自体の監視があります。

仮想マシンのホストの観点で確認できることとしては、仮想マシンが利用している CPU 使用率やディスク I/O、ディスクキャッシュのヒット率、ネットワークスループットなどのメトリックです。

仮想マシン自体の観点で確認できることとしては、仮想マシン上の OS から見たログとメトリックです。ログはイベントログや syslog などの OS やアプリケーションが出力するログです。メトリックは CPU 使用率やファイルシステムの利用量、プロセス数があります。

仮想マシンホストのメトリック収集は、Azure Monitor の機能として既定で提供されており、設定や追加のサービス展開は必要ありません。一方で仮想マシンのログとメトリックは、OS にエージェントをインストールすることでデータを収集します。

また、Azure 上の仮想マシンだけでなく、他社クラウドやオンプレミス環境のサーバーのメトリックやログを取得も可能です。

次の図は上記の内容をまとめたものです。

![](./images/overview-1.png)

なお、OS のログやメトリックの取得には、エージェントを利用する方法以外に、診断拡張機能を利用する方法もあります。診断拡張機能は、エージェントと別にインストールされる拡張機能で、拡張機能からストレージ アカウントのテーブルや Event Hub にデータが送信できます。以前は OS のメトリックをメトリック エクスプローラーへ送信するために使用されていました。しかしテーブルのメンテナンスが必要なことや簡単にクエリができないことから最近はログとしてのメトリックの収集や、Azure Monitor エージェントによるメトリックの送信が使われています。

以下の設定より診断拡張機能をインストールできます。

![](./image/../images/overview-vmdiag1.png)

以下に Infrastructure のデータソースの特徴を記述します。

- エージェントは `Azure Monitor エージェント` と `Log Analytics エージェント` の 2 種類
  - Log Analytics エージェントは2024年にリタイア予定のため、Azure Monitor エージェントを利用することを推奨
  - 詳細は後述
- Azure Monitor エージェントのインストールは、データ収集ルールを設定することで拡張機能として展開
  - 拡張機能の名前は、Linux は `AzureMonitorLinuxAgent`、Windows は`AzureMonitorWindowsAgent`
- Azure 以外の OS のデータを収集するためには Azure Arc に接続したうえでエージェントを展開
- Azure Monitor エージェントの Linux 拡張機能は以下のリポジトリで公開
  - https://github.com/Azure/azure-linux-extensions
- 参考ドキュメント
  - [Azure Monitor エージェントの概要](https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview)
  - [Azure Monitor エージェントを使用して仮想マシンからデータを収集する](https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal)

#### Azure Platform

Azure はデータベースや Web アプリケーションをホストするサービス、ファイアウォールを PaaS で提供しています。それらのリソースのログやメトリックも Azure Monitor で収集できます。たとえば、Web アプリケーションへのリクエスト数やファイアウォールのスループットがあります。ログとしては、Web アプリケーションのアクセスログやファイアウォールの通信ログがあり、`リソース ログ` や `診断ログ`と呼ばれます。

![](./images/logs-overview-platform.png)

メトリックは、Azure Monitor の機能として既定で提供されており、追加の設定やサービス展開は必要ありません。

リソース ログは、各リソースのメニューにある`診断設定`から設定します。上記の通りリソース ログはリソースによって出力するログの種類が異なります。診断設定では、どのログをどこに出力するかを設定します。また、複数の設定ができるため、同時に複数の Log Analytics や ストレージ アカウントへ出力できます。

以下は Azure Firewall の診断設定で Log Analytics ワークスペースへ出力している例です。
![](./images/overview-azfwdiag.png)

また、以下は、App Service の診断設定でストレージ アカウントへ出力している例です。Azure Firewall とログのカテゴリが異なっています。
![](images/overview-appservice.png)

プラットフォームのログとしてはほかに、リソースの作成や削除、アラート、メンテナンス情報等の管理系のログを記録している `アクティビティ ログ`、 ユーザーのサインインや監査ログを記録している `Azure Active Directory ログ` があります。これらのログも、診断設定から出力先を設定できます。

`アクティビティ ログ`は特に追加の設定をしなくても Azure で90日間保存され、その後削除されます。複雑な検索や長期保存をするためには、Log Analytics ワークスペース等の外部のサービスに出力します。

`Azure AD`のログについても、特に追加の設定なく Azure で保持されます。ただし、Azure AD のライセンスによって保持期間や保存できるログの種類が異なります。詳細は
[Azure AD にレポート データが保存される期間](https://learn.microsoft.com/ja-jp/azure/active-directory/reports-monitoring/reference-reports-data-retention)を参照してください。

### 2.2.2 データプラットフォーム

データプラットフォームは、データソースから収集したデータを蓄積するためのストレージです。Azure Monitor のストレージは、大きく分けてログとメトリックのそれぞれで保存される場所が違います。ログはユーザーが作成した Log Analytics ワークスペースに保存され、メトリックは Azure Monitor のデータストアに保存されます。

#### Azure Monitor メトリック データベース

仮想マシンの CPU 使用率や App Service のリクエスト数等の数値で表されるデータは、データソースから `Azure Monitor メトリック データベース` に保存されます。

![](./images/metrics-overview.png)

メトリック データベースは、ユーザーによる設定やサービスの展開をすることなく利用できる Azure Monitor 既定の機能です。メトリックデータの保存期間は、93日間です。コストも発生しません。

メトリックはデータによってディメンションを持っているものがあります。たとえば、仮想マシンのディスク I/O に関するメトリックは接続されているディスクごとで確認できる必要があります。ディメンションとしてLUNを持つことでメトリックの値を区別します。

メトリック データベースに対して、カスタム メトリックを定義してデータの収集が可能です。カスタム メトリックを利用するとユーザーが定義したメトリックをメトリック データベースに保存し、アラートや可視化が可能です。カスタム メトリックに対しては、保存容量に応じたコストが発生します。

メトリック データベースに保存されたデータは、後述するメトリック エクスプローラーから確認できます。

#### Log Analytics ワークスペース

Windows の イベント ログや Linux の Syslog などのログデータは、データソースから Log Analytics ワークスペースに保存できます。Azure リソースの診断設定で行ったログの出力も同様です。また、Application Insights を利用したアプリケーションからのログも Log Analytics ワークスペースに保存されます。

Log Analytics ワークスペースは、ユーザーが作成・管理します。データの保存にはコストが発生します。特に取り込むログ量への課金に多くのコストが発生するためログの取り込み対象の選定やワークスペースの分割が重要です。

Log Analytics ワークスペースに保存されたログは、ワークスペース内のストレージに構造化され格納されます。ログはデータソースに応じてテーブルが自動的に作成されそれぞれのテーブルに保存されます。たとえば、Application Gateway 等 Azure のリソースをデータソースにした場合、多くのリソースは、`AzureDiagnostics`というテーブルに保存されます。しかし、リソースによっては、リソース固有のスキーマを持ったテーブルに保存されることがあります。

![](./images/logs-structure.png)

Log Analytics ワークスペースに作成されたテーブルは、以下[テーブル]メニューから確認できます。

![](./images/overview-log-table.png)

### 2.2.3 データ利活用

収集した監視データは、Azure Monitor の機能を使ってさまざまな方法で利用できます。この節では代表的ないくつかの利用方法を紹介します。

#### メトリック エクスプローラー

メトリックデータベースに保存されたデータを確認するにはメトリック エクスプローラーを使用します。メトリック エクスプローラーを確認するために追加の設定やリソースの展開は必要ありません。メトリック エクスプローラーは各リソースの監視のメニューからアクセスできます。

以下は仮想マシンの CPU 使用率をメトリック エクスプローラーで確認した例です。

![](./images/overview-vmcpu.png)

メトリックの中には、ディメンジョン(次元)を持っているものがあります。たとえば、App Service は、CPU 使用率のメトリックを持っており、内部のインスタンスごとに CPU 使用率を確認できます。これは、CPU 使用率のメトリックに複数のディメンジョンを持っており、それぞれのメトリックにインスタンスの情報が含まれていることによるものです。メトリック エクスプローラーで確認するには、上部にある「分割を適用する」を利用します。

![](./images/overview-metric-dimension.png)

前述した通り、メトリックがデータベースに保存されている期間は93日です。メトリック エクスプローラー上で93日前までのデータが確認できますが、時間の範囲は最大30日のため、確認開始の日時を変更し30日ごとに確認していく必要があります。

|:question: Tips: メトリックの粒度と時間の範囲|
|:-----------------------------------------|
|Azure Monitor に収集されるメトリックはリソースによって断続的に送られるデータです。1分間に1回や5分間に1回等リソースが送信してきたデータを保存します。リソースによってこのサンプリングの間隔が異なるため、アラートの間隔等データを利用する際は注意しておく必要があります。|

- 参考ドキュメント
  - [Azure Monitor メトリックの概要](https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics#multi-dimensional-metrics)

#### Log Analytics ワークスペース

![](images/logs-overview.png)

データプラットフォームとしてストレージの役割を持つ Log Analytics ですが、取得したデータの検索や可視化をするための機能も備えています。Log Analytics ワークスペースに保存されたデータは、Kusto Query Language(KQL)と呼ばれるクエリ言語を使用してデータの検索が可能です。検索した結果は、グラフによる可視化やアラートによる通知として利用できます。

以下は、OS のログを KQL を使用して表示している例です。

![](./images/overview-loganalytics.png)

Log Analytics ワークスペースで実行したクエリの結果は、アラートやダッシュボードのソースとしても使えます。Web Apps のアクセスログや OS のログを取り込むとさまざまな場面で活用できます。

##### Kusto Query Language(KQL) とは

Kusto Query Language(KQL) は、Log Analytics ワークスペース上で利用できる強力なクエリ言語です。テーブルからのデータ取得やフィルター、ソート、マージ等さまざまなテーブル操作が利用できます。KQL を使いこなすことで大量のログの中から必要な情報を見つけ出すことができるため、使い方を理解することで分析やトラブルシューティングに役立ちます。

いくつか基本的な使い方を紹介します。

- テーブルの情報を参照

次のクエリは、`Event` テーブルのデータを取得しそのうちの100件を表示するコマンドです。このように、テーブル名を記述することでそのテーブルの情報を取得し、パイプ(|)でさまざまな処理をつなげていくことが可能です。

```kusto
Event | take 100
```

- テーブルのフィルター

次のクエリはログとして保存したメトリックのテーブル(AzureMetrics)からリソース名(Resource)が `CH1-SQLVM12` でかつ、メトリック名が CPU 使用率(Percentage CPU)のレコードを取得します。`where` で条件を指定します。

```kusto
AzureMetrics
| where Resource == "CH1-SQLVM12" and MetricName == "Percentage CPU"
```

- 期間の指定とグループ化

次のクエリは、診断ログのテーブル(AzureDiagnostics)から、今日の1週間分でフィルターし、さらに1日ごとにグループ化しています。

```kusto
AzureDiagnostics
| where TimeGenerated > startofweek(now())
| summarize count() by startofday(TimeGenerated)
```

- 参考ドキュメント
  - [KUSTO 100+ knocks](http://aka.ms/ftakusto)

#### アラート

Azure Monitor のアラートを利用すると、特定のリソースのメトリック・ログの変化に応じて、メールや SMS で通知を受け取ることができます。Azure Functions や Logic Apps、Webhook 等の外部のサービスとの連携もできるため、アラートのカスタマイズや複雑な処理を実現できます。

アラートを構成する上で必要な要素は、スコープ、条件、アクションです。

- スコープ
  - サブスクリプション全体や特定のリソースなどメトリックやログを持っている対象を指定します。
- 条件
  - 対象のスコープで利用できるシグナル(メトリックやログ)の指定、しきい値の設定、間隔等の条件を指定します。
- アクション
  - アラートがトリガーされた際に実行するアクションを指定します。

以下はアラートの条件として利用できるシグナルの代表的なものです。

- メトリック
- ログ
  - 診断ログ、OS のログ等の Log Analytics のログ
- アクティビティ ログ
- サービス正常性
- リソース正常性

※サービス正常性やリソース正常性は、アクティビティ ログの一種ですがアラートの設定としては別のシグナルとして扱われます。

メトリックやログはこれまでに紹介してきた方法で確認できる項目に対してアラートを設定できます。たとえば、メトリック エクスプローラーで確認しているメトリックに対してアラートを設定する場合、右上の「新しいアラート ルール」からアラートを作成できます。



#### NSG フローログ



## 2.3 そのほかの技術的なトピック

### Azure Log Analytics エージェントと Azure Monitor エージェント

前述の通り、現在仮想マシンへインストールエージェントは過渡期にあり、Azure Log Analytics エージェントと Azure Monitor エージェントが存在します。

### Log Analytics ワークスペースの課金と利用状況の分析

- アーカイブ
- 基本ログ
- 検索クエリ

### Log Analytics ワークスペースの権限管理

### サービス正常性、リソース正常性

## 2.4 まとめ
